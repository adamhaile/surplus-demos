<!doctype html>
<html>
<head>
    <title>Asteroids in Surplus.js</title>
    <style>
        html, body { margin:0; padding:0; overflow:hidden }
        svg.world, canvas {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: black;
        }
        circle, polygon, line {
            stroke: white;
            stroke-width: 1px;
            fill: none;
        }
        text {
            fill: white;
            font-size: 10px;
            font-family: helvetica, arial;
        }
    </style>
</head>
<body>
    <script type="text/javascript">

        function World(width, height) {
            var w = this,
                fps      = 60;

            this.t       = S.data(0);
            this.dt      = S.data(1 / fps);
            this.things  = S.array([]);
            this.width   = S.data(width);
            this.height  = S.data(height);
            this.running = S.data(false);

            var frame = S.data(0),
                frameTicker = function (t) { frame(t); requestAnimationFrame(frameTicker); };
            frameTicker(0);

            // runner
            var prior = 0;
            S.on([frame, this.running]).S(function () {
                if (!w.running()) return;
                if (prior) w.dt((frame() - prior) / 1000);
                prior = frame();
            });

            this.fps = S(function () { return 1 / w.dt(); });

            // t += dt
            S(function () { w.t(w.t() + w.dt()); });

            // wrap around edges
            //this.things.map(function (o) {
            //    var x = o.x(), y = o.y();
            //    if (x < 0)      o.x(x % width + width);
            //    if (x > width)  o.x(x % width);
            //    if (y < 0)      o.y(y % height + height);
            //    if (y > height) o.y(y % height);
            //});

            S.on(this.dt).S(function () {
                var things = w.things(),
                    dt = w.dt(),
                    i, thing, x, y;

                for (i = 0; i < things.length; i++) {
                    thing = things[i];

                    if (thing.dynamics()) thing.dynamics()(w, thing, dt);

                    // wrap around edges
                    x = thing.x(), y = thing.y();

                    if (x < 0)      thing.x(x % width + width);
                    if (x > width)  thing.x(x % width);
                    if (y < 0)      thing.y(y % height + height);
                    if (y > height) thing.y(y % height);
                }
            })

            this.makeCollisionSignal = function (X, Y) {
                var hitter = S.data(undefined),
                    hittee = S.data(undefined),
                    hitters = w.things.debounce(0).filter(function (t) { return t instanceof X; }),
                    hittees = w.things.debounce(0).filter(function (t) { return t instanceof Y; });

                hitter.hittee = hittee;

                S.on(this.dt).defer().S(function () {
                    var xs = hitters(),
                        ys = hittees(),
                        x, y, i, j;
                    for (i = 0; i < xs.length; i++) {
                        x = xs[i];
                        for (j = 0; j < ys.length; j++) {
                            y = ys[j];
                            if (dist(x, y) < x.radius() + y.radius()) {
                                hittee(y);
                                hitter(x);
                            }
                        }
                    }
                });

                return hitter;
            }
        }

        function Thing(w, d, remove) {
            var t = this;

            this.x        = S.data(0); // m
            this.y        = S.data(200); // m
            this.vx       = S.data(0); // m/s
            this.vy       = S.data(0); // m/s
            this.v        = S(function () { return Math.sqrt(t.vx() * t.vx() + t.vy() * t.vy()); });
            this.F        = S.data(0); // N
            this.tau      = S.data(0); // radians from vertical
            this.omega    = S.data(0); // radians / s
            this.torque   = S.data(0); // N m
            this.m        = S.data(50); // kg
            this.I        = S.data(10); // kg m^2
            this.radius   = S.data(0);
            this.dynamics = S.data(d);
            this.remove   = remove;

            //S.on(w.dt).S(function () { this.dynamics() && this.dynamics()(w, this, w.dt()); });

            w.things.push(this);
            S.cleanup(function () { w.things.remove(t); });
        }

        function FreeFloating(w, o, dt) {
            o.x(o.x() + o.vx() * dt);
            o.y(o.y() + o.vy() * dt);
            o.tau(o.tau() + o.omega() * dt);
        }

        function Propelled(w, o, dt) {
            var a = o.F() / o.m();
            o.vx(o.vx() - a * Math.sin(o.tau()) * dt);
            o.vy(o.vy() + a * Math.cos(o.tau()) * dt);

            o.omega(o.omega() + o.torque() / o.I() * dt);

            FreeFloating(w, o, dt);
        }

        function Stationary(w, o, dt) {
            if (o.vx()) o.vx(0);
            if (o.vy()) o.vy(0);
            if (o.omega()) o.omega(0);
        }

        function rand(min, max) {
            if (max === undefined) max = min, min = 0;
            min = min || 0, max = max || 1;
            return Math.random() * (max - min) + min;
        }

        function Constructor(fn) {
            return function (/* args */) {
                var self = this,
                    args = [].slice.call(arguments);
                args.push(function () { f.dispose(); });
                var f = S.once().S(function () { return fn.apply(self, args); });
                return f() === undefined ? this : f();
            }
        }

        function dist(a, b) {
            return Math.sqrt(Math.pow(a.x() - b.x(), 2) + Math.pow(a.y() - b.y(), 2));
        }
    </script>
    <script type="text/javascript-htmlliterals">
        var Game = Constructor(function (dispose) {
                var g = this;
                //World.call(this, 1000 * innerWidth / (innerWidth + innerHeight), 1000 * innerHeight / (innerWidth + innerHeight));
                World.call(this, innerWidth, innerHeight);

                this.ships = S.data(3);
                this.ship = S.data(new Ship(this));

                this.player = S.data(new Player(this));

                this.lose = S(function () { return g.ships() === 0; });
                this.win = S.defer().S(function () { return !g.things().some(function (t) { return t instanceof Asteroid; }); });
                this.over = S(function () { return g.win() || g.lose(); });
                this.paused = S(function () { return !g.over() && !g.running(); });

                this.invincible = S.data(false);

                var asteroidHitsShip = this.makeCollisionSignal(Asteroid, Ship);
                var bulletHitsAsteroid = this.makeCollisionSignal(Bullet, Asteroid);

                S.when(asteroidHitsShip).S(function () {
                    if (g.invincible()) return;
                    g.ship().destroyed(true);
                    g.running(false);
                });

                S.when(bulletHitsAsteroid).S(function () {
                    var b = bulletHitsAsteroid(),
                        a = bulletHitsAsteroid.hittee(),
                        c;

                    //if (a.destroyed()) return;
                    a.destroyed(true);

                    if (a.radius() > 5) {
                        S.pin(function () {
                            c = new Asteroid(g, Math.round(a.radius() / 3));
                            c.x(a.x()), c.y(a.y());
                            c = new Asteroid(g, Math.round(a.radius() / 3));
                            c.x(a.x()), c.y(a.y());
                            c = new Asteroid(g, Math.round(a.radius() / 3));
                            c.x(a.x()), c.y(a.y());
                        })
                    }

                    b.remove();
                    a.remove();
                });

                new Asteroid(this, 40);
                new Asteroid(this, 40);
                new Asteroid(this, 40);

                this.start = function () {
                    if (g.over()) return;
                    if (g.ship().destroyed()) {
                        g.ship().remove();
                        if (asteroidHitsShip()) asteroidHitsShip().remove();
                        g.ships(this.ships() - 1);
                        g.ship(new Ship(g));
                    }
                    g.running(true);
                };
            }),
            Player = Constructor(function (w) {
                this.engineOn    = function () { w.ship().F(2000); };
                this.engineOff   = function () { w.ship().F(0); };
                this.turnLeft    = function () { w.ship().omega(-3); };
                this.turnRight   = function () { w.ship().omega(3); };
                this.stopTurning = function () { w.ship().omega(0); };
                this.fire        = function () { new Bullet(w, w.ship().tau(), w.ship()); };
                this.pause       = function () { w.running(false); };
                this.bench       = function () {
                    S.once().S(function () {
                        w.invincible(true);
                        for (var i = 0; i < 1000; i++) {
                            var a = new Bullet(w, Math.PI * 2 * i / 1000, w.ship());
                        }
                    });
                }
            }),
            Ship = Constructor(function (w, dispose) {
                Thing.call(this, w, Propelled, dispose);

                this.x(w.width() / 2);
                this.y(w.height() / 2);

                this.radius(10);

                this.destroyed = S.data(false);
            }),
            Asteroid = Constructor(function (w, size, dispose) {
                Thing.call(this, w, FreeFloating, dispose);

                this.radius(size);

                var v = rand(10, 60 - size),
                    omega = rand(0, Math.PI * 2);

                this.omega(omega);
                this.vx(Math.cos(omega) * v);
                this.vy(Math.sin(omega) * v);

                this.destroyed = S.data(false);

                if (rand() < 0.5) {
                    this.x(Math.round(rand()) * w.width());
                    this.y(rand(w.height()));
                } else {
                    this.x(rand(w.width()));
                    this.y(Math.round(rand()) * w.height());
                }
            }),
            Bullet = Constructor(function (w, tau, firer, dispose) {
                Thing.call(this, w, FreeFloating, dispose);

                this.radius(1);
                this.x(firer.x());
                this.y(firer.y());

                var v = 200,
                    sin = Math.sin(tau),
                    cos = Math.cos(tau);

                this.vx(-sin * v + firer.vx());
                this.vy(cos * v + firer.vy());

                var t = w.t() + (Math.abs(sin) * w.width() + Math.abs(cos) * w.height()) * 0.8 / (v + firer.v());

                //setTimeout(dispose, t * 1000);
                S(function () { w.t() > t && dispose(); });
            }),
            View = function (g) {
                new Html(document.body)
                    .onkey(function (d) { d('uparrow',    'down', function () { g.player().engineOn(); }); })
                    .onkey(function (d) { d('uparrow',    'up',   function () { g.player().engineOff(); }); })
                    .onkey(function (d) { d('leftarrow',  'down', function () { g.player().turnLeft(); }); })
                    .onkey(function (d) { d('leftarrow',  'up',   function () { g.player().stopTurning(); }); })
                    .onkey(function (d) { d('rightarrow', 'down', function () { g.player().turnRight(); }); })
                    .onkey(function (d) { d('rightarrow', 'up',   function () { g.player().stopTurning(); }); })
                    .onkey(function (d) { d('space',      'down', function () { g.running() ? g.player().fire() : g.start(); }); })
                    .onkey(function (d) { d('p',          'down', function () { g.running(false); }); })
                    .onkey(function (d) { d('b',          'down', function () { g.player().bench(); }); });

                var things = g.things.map(function (t) { return (
                        t instanceof Ship ?
                            <svg class = "ship"
                                 @attr:x = (t.x() - 15)
                                 @attr:y = (t.y() - 15)
                                 width = "30"
                                 height = "30">
                                <g @attr:transform = ("rotate(" + (t.tau() * 180 / Math.PI) + " 15 15)")>
                                    <polygon points = "10,12 15,25 20,12, 18,14 12,14" />
                                    <polygon points = "14,5 14,15 16,15 16,5" style.opacity = (t.F() ? 1 : 0)/>
                                    <polygon points = "15,23 10,23 10,24 15,24 15,23" style.opacity = (t.omega() < 0 ? 1 : 0)/>
                                    <polygon points = "15,23 20,23 20,24 15,24 15,23" style.opacity = (t.omega() > 0 ? 1 : 0)/>
                                </g>
                            </svg> :
                        t instanceof Bullet ?
                            <line class="bullet" x1 = "0" x2 = "0" @attr:x2 = (t.vx() * 0.02) @attr:y2 = (t.vy() * 0.02)
                                  @attr:transform = ("translate(" + t.x() + " " + t.y() + ")") /> :
                        t instanceof Asteroid ?
                            <circle class="asteroid" cx = "0" cy = "0" @attr:r = t.radius()
                                    @attr:transform = ("translate(" + t.x() + " " + t.y() + ")") /> :
                        null
                    )});

                return (
                    <svg class="world"
                         @attr:viewBox = ("0 0 " + g.width() + " " + g.height())
                         preserveAspectRatio = "xMidYMax">

                        @things()

                        @Array.apply(0, new Array(g.ships())).map(function (_, i) {
                            <svg @attr:x = (g.width() - 30 * i - 30) y = "0">
                                <polygon points = "10,15 15,25 20,15" />
                            </svg>
                        })

                        <text x="0" y="15">fps:    </text><text x="60" y="15">@g.fps().toFixed(1)</text>
                        <text x="0" y="30">objects:</text><text x="60" y="30">@g.things().length</text>
                        <text x="0" y="45">obj/s:  </text><text x="60" y="45">@(g.things().length * g.fps()).toFixed(0)</text>

                        <text @attr:x = (g.width() / 2) @attr:y = (g.height() / 2 + 40) text-anchor="middle">
                            @(g.paused() ? "-- hit space to start --" :
                              g.lose()   ? "-- game over --" :
                              g.win()    ? "-- you win! --" :
                                           "")
                        </text>
                    </svg>
                );
            },
            CanvasView = function (g) {
                new Html(document.body)
                .onkey(function (d) { d('uparrow',    'down', function () { g.player().engineOn(); }); })
                .onkey(function (d) { d('uparrow',    'up',   function () { g.player().engineOff(); }); })
                .onkey(function (d) { d('leftarrow',  'down', function () { g.player().turnLeft(); }); })
                .onkey(function (d) { d('leftarrow',  'up',   function () { g.player().stopTurning(); }); })
                .onkey(function (d) { d('rightarrow', 'down', function () { g.player().turnRight(); }); })
                .onkey(function (d) { d('rightarrow', 'up',   function () { g.player().stopTurning(); }); })
                .onkey(function (d) { d('space',      'down', function () { g.running() ? g.player().fire() : g.start(); }); })
                .onkey(function (d) { d('p',          'down', function () { g.running(false); }); })
                .onkey(function (d) { d('i',          'down', function () { g.invincible(true); }); })
                .onkey(function (d) { d('b',          'down', function () { g.player().bench(); }); });

                var canvas = <canvas width = g.width() height = g.height()></canvas>,
                    ctx = canvas.getContext("2d");

                ctx.font = "18px helvetica";
                ctx.strokeStyle = "white";
                //ctx.lineWidth = 2.0;
                ctx.fillStyle = "white";

                S.on(g.dt).S(function () {
                    ctx.clearRect(0, 0, g.width(), g.height());

                    var things = g.things(), i, t;

                    for (i = 0; i < things.length; i++) {
                        t = things[i];

                        if (t instanceof Ship) {
                            ctx.save();
                            ctx.translate(t.x(), t.y());
                            ctx.rotate(t.tau());
                            ctx.beginPath();
                            ctx.moveTo(-10, -6);
                            ctx.lineTo(0, 20);
                            ctx.lineTo(10, -6);
                            ctx.lineTo(6, -2);
                            ctx.lineTo(-6, -2);
                            if (t.F()) {
                                ctx.moveTo(2, -2);
                                ctx.lineTo(4, -20);
                                ctx.moveTo(-2, -2);
                                ctx.lineTo(-4, -20);
                            }
                            if (t.omega() > 0) {
                                ctx.moveTo(4, 14);
                                ctx.lineTo(14, 14);
                            } else if (t.omega() < 0) {
                                ctx.moveTo(-4, 14);
                                ctx.lineTo(-14, 14);
                            }
                            ctx.closePath();
                            ctx.stroke();
                            ctx.restore();
                        } else if (t instanceof Bullet) {
                            ctx.beginPath();
                            ctx.moveTo(t.x(), t.y());
                            ctx.lineTo(t.x() + t.vx() * 0.04, t.y() + t.vy() * 0.04);
                            ctx.closePath();
                            ctx.stroke();
                        } else if (t instanceof Asteroid) {
                            ctx.beginPath();
                            ctx.arc(t.x(), t.y(), t.radius(), 0,  Math.PI * 2, false);
                            ctx.closePath();
                            ctx.stroke();
                        }
                    }

                    ctx.fillText("fps:", 0, 20);       ctx.fillText(g.fps().toFixed(0), 75, 20);
                    ctx.fillText("objects:", 0, 40);   ctx.fillText(things.length, 75, 40);
                    ctx.fillText("objs/s:", 0, 60);    ctx.fillText((g.fps() * things.length).toFixed(0), 75, 60);

                    var msg = g.paused() ? "-- hit space to start --" :
                              g.lose()   ? "-- game over --" :
                              g.win()    ? "-- you win! --" :
                              null;

                    if (msg) ctx.fillText(msg, (g.width() - ctx.measureText(msg).width) / 2, g.height() / 2 + 40);
                });

                return canvas;
            },
            game = new Game(),
            view = S.defer().once().S(CanvasView, game);

        document.body.appendChild(view());
    </script>
    <script type="text/javascript" src="../surplus/dist/surplus.js"></script>
    <script type="text/javascript" src="../S-array/src/S.array.js"></script>
</body>
</html>
